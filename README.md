# twinscale-operator

---

## Repository Layout (top level)

```
twinscale-operator/
├── .dockerignore             # Files to exclude when building the operator’s container image
├── .gitignore                # Git ignore rules
├── .golangci.yml             # Configuration for golangci-lint
├── Dockerfile                # Instructions to build the operator image (ghcr.io/emereshub/twinscale-operator)
├── Makefile                  # “make” targets: manifests, install, build, docker-build, deploy, etc.
├── PROJECT                   # Kubebuilder project metadata (domain, repository, version)
├── README.md                 # (This file)
├── go.mod / go.sum           # Go modules manifest
├── kind-config.yaml          # KinD cluster configuration (node roles, port mapping)
├── config/                   # Kustomize overlays and manifest fragments
│   ├── crd/                  # “config/crd/bases/…”: raw CRD YAMLs (generated by `make manifests`)
│   │   ├── kustomization.yaml
│   │   ├── kustomizeconfig.yaml
│   │   └── bases/            # per-CRD YAML under bases/
│   ├── default/              # Default overlay: stitches together CRDs + manager + RBAC
│   │   ├── kustomization.yaml
│   │   └── namespace.yaml    # default namespace for operator
│   ├── manager/              # Kustomize overlay for the operator Deployment, ServiceAccount, RBAC
│   │   ├── kustomization.yaml
│   │   ├── manager_auth_proxy_patch.yaml
│   │   ├── manager_config_patch.yaml
│   │   └── manager_image_patch.yaml
│   └── samples/              # example CR manifest(s) for manual sanity checks
│       └── …                 
├── api/                      # API group/version definitions (Go types + markers → CRD generator)
│   ├── core/                 # core/v0 API types (e.g. TwinScaleJob, TwinScaleGraph)
│   │   └── v0/
│   │       ├── api_types.go
│   │       └── groupversion_info.go
│   └── dtd/                  # “Digital Twin Domain” types (dtd/v0)
│       └── v0/
│           ├── api_types.go
│           └── groupversion_info.go
├── cmd/                      # Entrypoint for the operator (wires up manager & controllers)
│   └── main.go
├── internal/                 # Controller implementation (non-public packages)
│   └── controller/
│       ├── core/             # Reconciler loops for core resources
│       └── dtd/              # Reconciler loops for “digital twin” domain objects
├── pkg/                      # Shared libraries / utilities used by controllers
│   ├── event/                # Event pub/sub abstractions
│   ├── event-store/          # Interfaces + implementations for event storage (Postgres, Redis)
│   ├── graph/                # Graph data structures & algorithms for Twin relationships
│   ├── historical-data-store/ # Interfaces for historical‐metrics storage
│   ├── naming/               # Naming conventions for generated K8s objects (ConfigMaps, etc.)
│   ├── service/              # Service-layer abstractions (business APIs) for controllers
│   ├── third-party/          # Wrappers for Kafka / RabbitMQ / Knative / etc.
│   └── visualisation/        # Visualization logic (e.g. Grafana dashboards)
├── hack/                     # Helper scripts to bootstrap “third-party” dependencies
│   ├── install-helm.sh       # Installs Helm onto the cluster (if missing)
│   ├── install-redis.sh      # Deploys Redis via Helm (in correct namespace)
│   ├── pre-setup-twinscale.sh # Creates namespaces, ServiceAccounts, RBAC, etc.
│   ├── setup-knative-operator.sh  # Installs Istio, Knative Serving & Eventing
│   ├── setup-brokers.sh      # Deploys RabbitMQ StatefulSet + Knative broker CRs
│   ├── setup-postgresql.sh   # Deploys PostgreSQL (Bitnami chart)
│   ├── deploy-monitoring.sh  # (Optional) Deploys Prometheus & Grafana
│   ├── kind-config.yaml      # Duplicate KinD config for local convenience
│   └── boilerplate.go.txt    # Boilerplate header used by code gen
```


* **`Dockerfile`**
  Builds the operator image (`ghcr.io/emereshub/twinscale-operator:<tag>`).

* **`Makefile`**

  * `make manifests`: generate CRD YAMLs under `config/crd/bases/`.
  * `make install`: apply CRDs (`kubectl apply --server-side -f config/crd/bases`).
  * `make build`: compile the operator binary.
  * `make docker-build IMG=$(IMG)`: build/tag the Docker image.
  * `make deploy IMG=$(IMG)`: patch image in `config/manager` and apply `config/default/`.
  * `make uninstall`: remove CRDs, CRs, and RBAC.
  * Other standard Kubebuilder targets (`fmt`, `vet`, `lint`).

* **`config/`**

  * **`crd/bases/`**: generated CRD definitions.
  * **`manager/`**: Deployment, ServiceAccount, RBAC for the operator (manager image is patched here).
  * **`default/`**: single kustomization that assembles `crd/` + `manager/`.
  * **`samples/`**: example CR manifests.

* **`api/`**
  Go types and markers for CRD generation—two groups: `core/v0` and `dtd/v0`.

* **`cmd/main.go`**
  Sets up the controller-runtime manager, registers schemes and reconcilers.

* **`internal/controller/`**
  Reconciler implementations for each CR (“core” and “dtd” logic).

* **`pkg/`**
  Shared libraries (event handling, storage interfaces, graph logic, third-party integrations, visualization).


* **`hack/`**
  Bootstrap scripts for dependencies:

  1. `install-helm.sh` (Helm)
  2. `install-redis.sh` (Redis via Helm)
  3. `pre-setup-twinscale.sh` (namespaces, ServiceAccounts, RBAC)
  4. `setup-knative-operator.sh` (Istio, Knative Serving & Eventing)
  5. `setup-brokers.sh` (RabbitMQ cluster + Knative broker)
  6. `setup-postgresql.sh` (PostgreSQL via Bitnami chart)
  7. `deploy-monitoring.sh` (Prometheus & Grafana, optional)

---

## Deployment into a Cluster Named `twinscale-cluster`

**Assumptions**

* You already have a Kubernetes cluster named `twinscale-cluster` and a corresponding kubeconfig context.
* `ghcr.io/emereshub` is reachable from that cluster (or imagePullSecrets are set).
* You’ll use only the existing `hack/` scripts and Makefile targets—no new scripts are needed.

---

1. **Point kubectl at `twinscale-cluster`**

   ```bash
   export KUBECONFIG="${HOME}/.kube/config"
   kubectl config use-context twinscale-cluster
   ```

2. **Generate & install CRDs**

   ```bash
   make manifests      # (only if you’ve changed api/)
   make install        # kubectl apply --server-side -f config/crd/bases/
   ```

3. **Bootstrap third-party dependencies (in exact order)**

   ```bash
   bash hack/install-helm.sh         # (optional) installs Helm
   bash hack/install-redis.sh        # (optional) deploys Redis via Helm
   bash hack/pre-setup-twinscale.sh  # creates namespaces + RBAC
   bash hack/setup-knative-operator.sh  # installs Istio + Knative Serving/Eventing
   bash hack/setup-brokers.sh        # deploys RabbitMQ + Knative broker
   bash hack/setup-postgresql.sh     # deploys PostgreSQL (Bitnami chart)
   bash hack/deploy-monitoring.sh    # (optional) Prometheus & Grafana
   ```


4. **Deploy the TwinScale Operator**

   ```bash
   make deploy IMG=ghcr.io/emereshub/twinscale-operator:0.1
   ```

5. **Verify**

   ```bash
   kubectl get pods -n twinscale-operator-system
   kubectl logs -n twinscale-operator-system -l control-plane=controller-manager --tail=100 -f
   kubectl get crds | grep twinscale
   ```

That’s it—run those commands in order (with the variables set as shown) and your operator will be up and running in `twinscale-cluster`.
